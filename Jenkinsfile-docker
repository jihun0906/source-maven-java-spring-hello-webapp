pipeline {
    agent none

    stages {
        stage('Checkout') {
            agent any
            steps {
                // [중요] credentialsId를 꼭 넣어주세요 (앞서 설정한 ID)
                git branch: 'main', 
                    url: 'https://github.com/jihun0906/source-maven-java-spring-hello-webapp.git',
                    credentialsId: 'git-creds' 
            }
        }
        stage('Build') {
            agent {
                docker { image 'maven:3-openjdk-17' }
            }
            steps {
                sh 'mvn clean package'
            }
        }
        stage('Build Image') {
            agent any
            steps {
                // 여기서 tomcat:hello-world 로 빌드했습니다.
                sh 'docker image build -t tomcat:hello-world .'
            }
        }
        stage('ImageTag') {
            agent any
            steps {
                // [수정 1] tomecat -> tomcat (오타 수정)
                // [수정 2] 뒤에 붙는 이름을 jihunjeon/tomcat 으로 통일
                sh 'docker image tag tomcat:hello-world jihunjeon/tomcat:latest'
            }
        }
        stage('ImagePush') {
            agent any
            steps {
                withDockerRegistry(credentialsId: 'docker-hub-token', url: 'https://index.docker.io/v1/') {
                    // [수정 3] 태그했던 이름(jihunjeon/tomcat)과 똑같은 이름을 푸시해야 합니다.
                    sh 'docker image push jihunjeon/tomcat:latest'
                }
            }
        }
        stage('Running Container') {
            agent any 
            // 굳이 dind 이미지를 쓸 필요 없이, agent any에서 ssh나 원격 명령을 날리는 게 낫습니다.
            // 하지만 dind를 꼭 써야 한다면 그대로 두셔도 됩니다.
            steps {
                // [수정 4] --d -> -d (하이픈 하나)
                // [수정 5] 실행할 이미지 이름도 jihunjeon/tomcat 으로 통일
                sh 'docker -H tcp://192.168.56.104:2375 container run -d --name webapp -p 80:8080 jihunjeon/tomcat:latest'
            }
        }
    }
}

pipeline {
    agent {
      kubernetes{
	yalm '''
apiVersion: v1
kind: Pod
metadata:
  name: myapp-pod
spec:
  containers:
    - name: myven
      image: maven:3.8.5-openjdk-17
      command:
	- slep
      args:
	- infinity
apiVersion: v1
kind: Pod
metadata:
  name: myapp-pod
spec:
  containers:
    - name: kaniko
      image: gcr.io/kaniko-project/executor:debug
      command:
        - slep
      args:
        - infinity
      volumeMounts:
	- name: registry-credentials
	  mountPath: /kaniko/.docker
  volumes:
    - name: registry-credentials
      secret:
        secretName: regcred
        items:
	  - key: .dockerconfigjson
	    path: config.json
'''
	}
     }

    triggers {
        pollSCM('* * * * *')
    }

    stages {
        stage('Checkout') {
            steps {
	      container('maven')
		git branch: 'main'
                    url: 'https://github.com/jihun0906/source-maven-java-spring-hello-webapp.git'
            }
        }
      }
        stage('Build & Test') {
            steps {
		container('maven') {
                sh 'mvn clean package'
            }
        }
      }
        stage('Build & Push') {
            steps {
	      container('kaniko') {
	       sh'executor --context=dir://home/jenkins/agent/workspec/test/ --destination=jihunjeon/k8s:$BUILD_NUMBER --destination=jihunjeon/k8s:latest'
            }
        }
    }
}
